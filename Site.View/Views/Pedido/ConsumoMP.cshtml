@using System.Globalization
@using Site.DTO.Relatorio
@using Site.Enums
@using Site.View.ViewModel
@model IEnumerable<RelatorioMateriaPrimaViewModel>
@{
    var relatorioAviamento = TempData["RelatorioAviamento"] as IList<DTORelatorioAviamento>;
    
    var filtro = TempData["Filtro"] as DTOFiltroRelatorioMP;
    if (filtro.ExibirSubTotal && Model.Any())
    {
        var pedidos = Model.Select(x => x.Pedido).Distinct();
        var pedidosString = pedidos.Aggregate(string.Empty, (current, item) => current + (" / " + item));
        
        <legend class="mostrar hidden">Pedidos: @pedidosString</legend>
        
        double subTotalConsumo = 0.00;
        double subTotalTotal = 0.00;
        string subTotalString = Model.First().Tecido;
        string unidadeMedida = Model.First().UnidadeMedida;

        IList<string> pedidosSubtotal = new List<string>();
        IList<string> produtosSubtotal = new List<string>();
        IList<string> qtdeprodutosSubtotal = new List<string>();
        
        <div class="" style="margin-left:20px; width: 1300px ">
            <legend>Consumo Tecido</legend><div style="margin-top: -20px;margin-bottom: 10px"><input class='apenasSubtotal' id="apenasSubtotal" type='checkbox' name='apenasSubtotal' value='0' style="margin-top: -2px" /> Apenas SubTotal </div>
            <table class="table table-condensed table-bordered" width="100%">
                <tr>
                    <th class="">
                        Pedidos
                    </th>            
                    <th class="">
                        Qtde
                    </th>
                    <th class="">
                        Produtos
                    </th>
                    <th class="esconder">
                        Qtde
                    </th>
                    <th class="esconder">
                        Corpo/Parte/Acréscimo
                    </th>
                    <th>
                        Tecido
                    </th>
                    <th class="esconder">
                        Consumo
                    </th>
                    <th>
                        Total de Tecido
                    </th>
                    <th>
                        MT/KG
                    </th>
                </tr>
                @foreach (var item in Model)
                {
                    if (subTotalString == item.Tecido)
                    {
                        <tr class="esconder">
                            <td>
                                @Html.DisplayFor(modelItem => item.Pedido)
                            </td>                
                            <td>
                                @Html.DisplayFor(modelItem => item.Qtde)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Produto)
                            </td>
                            <td>
                                @{
                                    var quantidade = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                                }
                                @quantidade
                            </td>
                            <td>
                                @item.ParteAcrescimo
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Tecido)
                            </td>
                            <td class="esconder">
                                @item.Consumo.ToString("N2")
                            </td>
                            <td>
                                @item.SubTotalConsumo.ToString("N2")
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.UnidadeMedida)
                            </td>
                        </tr>
                        subTotalConsumo += item.Consumo;
                        subTotalTotal += item.SubTotalConsumo;
                        if (!pedidosSubtotal.Contains(item.Pedido))
                        {
                            pedidosSubtotal.Add(item.Pedido);
                        }
                        if (!produtosSubtotal.Contains(item.Produto))
                        {
                            produtosSubtotal.Add(item.Produto);
                            qtdeprodutosSubtotal.Add(item.Qtde.ToString(CultureInfo.InvariantCulture));
                        }
                        else if (!qtdeprodutosSubtotal.Contains(item.Qtde.ToString(CultureInfo.InvariantCulture)))
                        {
                            qtdeprodutosSubtotal.Add(item.Qtde.ToString(CultureInfo.InvariantCulture));
                        }
                    }
                    else
                    {
                        <tr>
                            <th>
                                @{
                                    foreach (var p in pedidosSubtotal)
                                    {
                                        <p style="margin-bottom: 0">@p</p>
                                    }
                                }    
                            </th>
                            <th>
                                @{
                                    foreach (var q in qtdeprodutosSubtotal)
                                    {
                                        <p style="margin-bottom: 0">@q</p>
                                    }
                                }                                
                            </th>
                            <th>
                                @{
                                    foreach (var prd in produtosSubtotal)
                                    {
                                        <p style="margin-bottom: 0">@prd</p>
                                    }
                                }
                            </th>
                            <th class="esconder"></th>
                            <th class="esconder"></th>
                            <th>@subTotalString</th><th class="esconder">@subTotalConsumo.ToString("N2")</th><th>@subTotalTotal.ToString("N2")</th><th>@unidadeMedida</th>
                        </tr>
                        pedidosSubtotal.Clear();
                        produtosSubtotal.Clear();
                        qtdeprodutosSubtotal.Clear();
                        subTotalConsumo = 0.00;
                        subTotalTotal = 0.00;
                        subTotalString = item.Tecido;
                        unidadeMedida = item.UnidadeMedida;
                        <tr class="esconder">
                            <td>
                                @Html.DisplayFor(modelItem => item.Pedido)
                            </td>                
                            <td>
                                @Html.DisplayFor(modelItem => item.Qtde)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Produto)
                            </td>
                            <td>
                                @{
                                    var quantidade = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                                }
                                @quantidade
                            </td>
                            <td>
                                @item.ParteAcrescimo
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.Tecido)
                            </td>
                            <td class="esconder">
                                @item.Consumo.ToString("N2")
                            </td>
                            <td>
                                @item.SubTotalConsumo.ToString("N2")
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.UnidadeMedida)
                            </td>
                        </tr>
                        subTotalConsumo += item.Consumo;
                        subTotalTotal += item.SubTotalConsumo;
                        if (!pedidosSubtotal.Contains(item.Pedido))
                        {
                            pedidosSubtotal.Add(item.Pedido);
                        }
                        if (!produtosSubtotal.Contains(item.Produto))
                        {
                            produtosSubtotal.Add(item.Produto);
                            qtdeprodutosSubtotal.Add(item.Qtde.ToString(CultureInfo.InvariantCulture));
                        }                        
                    }
                }
                <tr>
                    <th>
                        @{
                            foreach (var p in pedidosSubtotal)
                            {
                                <p style="margin-bottom: 0">@p</p>
                            }
                        }
                    </th>
                    <th>
                        @{
                            foreach (var q in qtdeprodutosSubtotal)
                            {
                                        <p style="margin-bottom: 0">@q</p>
                            }
                        }                            
                    </th>
                    <th>
                        @{
                            foreach (var prd in produtosSubtotal)
                            {
                                <p style="margin-bottom: 0">@prd</p>
                            }
                        }                        
                    </th>
                    <th class="esconder"></th>
                    <th class="esconder"></th><th>@subTotalString</th><th class="esconder">@subTotalConsumo.ToString("N2")</th><th>@subTotalTotal.ToString("N2")</th><th>@unidadeMedida</th>
                </tr>
            </table>
        </div>
    }
    else
    {
        <div class="" style="margin-left:20px; width: 1300px ">
            <legend>Consumo Matéria Prima</legend>
            <table class="table table-condensed table-bordered" width="100%">
                <tr>
                    <th>
                        Pedido
                    </th>            
                    <th>
                        Qtde
                    </th>
                    <th>
                        Produto
                    </th>
                    <th>
                        Qtde
                    </th>
                    <th>
                        Corpo/Parte/Acréscimo
                    </th>
                    <th>
                        Tecido
                    </th>
                    <th>
                        Consumo
                    </th>
                    <th>
                        Total de Tecido
                    </th>
                    <th>
                        MT/KG
                    </th>
                </tr>
                @foreach (var item in Model)
                {
                    <tr class="esconder">
                        <td>
                            @Html.DisplayFor(modelItem => item.Pedido)
                        </td>                
                        <td>
                            @Html.DisplayFor(modelItem => item.Qtde)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Produto)
                        </td>
                        <td>
                            @{
                                var quantidade = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @quantidade
                        </td>
                        <td>
                            @item.ParteAcrescimo
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Tecido)
                        </td>
                        <td>
                            @item.Consumo.ToString("N2")
                        </td>
                        <td>
                            @item.SubTotalConsumo.ToString("N2")
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.UnidadeMedida)
                        </td>
                    </tr>
                }
            </table>
        </div>        
    }
}

@if(filtro.ExibirAviamentos && relatorioAviamento != null && relatorioAviamento.Any())
{
     
    <div class="" style="margin-left:20px; width: 1300px ">
        <legend>Consumo Aviamento</legend>
        
        @if (!filtro.ExibirSubTotal)
        {          
            <table class="table table-condensed table-bordered" width="100%">
                <tr>
                    <th>
                        Pedido
                    </th>
                    <th>
                        Qtde
                    </th>
                    <th>
                        Produto
                    </th>
                    <th>
                        Qtde
                    </th>
                    <th>
                        Parte/Acréscimo
                    </th>
                    <th>
                        Qtde
                    </th>
                    <th>
                        Aviamento
                    </th>
                    <th>
                        Consumo
                    </th>
                    <th>
                        Total de Aviamento
                    </th>
                </tr>
        
                @foreach (var item in relatorioAviamento)
                {
                   <tr class="esconder">
                        <td>@item.Pedido</td>
                        <td>
                            @{
                                var qtdeProd = item.QtdeProduto > 0 ? item.QtdeProduto.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeProd
                        </td>
                        <td>@item.ProdutoNome</td>
                        <td>
                            @{
                                var qtdePA = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdePA                    
                        </td>
                        <td>@item.ParteAcrescimoNome</td>
                        <td>
                            @{
                                var qtdeA = item.QtdeAviamento > 0 ? item.QtdeAviamento.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeA
                        </td>
                        <td>@item.AviamentoNome</td>
                        <td>@item.AviamentoConsumo.ToString("N2")</td>
                        <td>
                            @{
                                var subTotal = (item.QtdeProduto > 0 ? item.QtdeProduto : 1)
                                               * (item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo : 1)
                                               *(item.QtdeAviamento > 0 ? item.QtdeAviamento : 1)
                                               *item.AviamentoConsumo;
                            }
                            @subTotal.ToString("N2")
                        </td>
                    </tr>

                }
            </table>
        }
        else
        {

            string subTotalStringAv = relatorioAviamento.First().AviamentoNome;
            var subTotalConsumoAv = 0.00;
            var subTotalTotalAv = 0.00;
            
        <table class="table table-condensed table-bordered" width="100%">
            <tr>
                <th class="esconder">
                    Pedido
                </th>
                <th class="esconder">
                    Qtde
                </th>
                <th class="esconder">
                    Produto
                </th>
                <th class="esconder">
                    Qtde
                </th>
                <th class="esconder">
                    Parte/Acréscimo
                </th>
                <th class="esconder">
                    Qtde
                </th>
                <th>
                    Aviamento
                </th>
                <th>
                    Consumo
                </th>
                <th>
                    Total de Aviamento
                </th>
            </tr>

            @foreach (var item in relatorioAviamento)
            {
                if (subTotalStringAv == item.AviamentoNome)
                {
                   <tr class="esconder">
                        <td>@item.Pedido</td>
                        <td>
                            @{
                                var qtdeProd = item.QtdeProduto > 0 ? item.QtdeProduto.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeProd
                        </td>
                        <td>@item.ProdutoNome</td>
                        <td>
                            @{
                                var qtdePASubtotal = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdePASubtotal
                        </td>
                        <td>@item.ParteAcrescimoNome</td>
                        <td>
                            @{
                                var qtdeA = item.QtdeAviamento > 0 ? item.QtdeAviamento.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeA
                        </td>
                        <td>@item.AviamentoNome</td>
                        <td>@item.AviamentoConsumo.ToString("N2")</td>
                        <td>
                            @{
                                var subTotal = (item.QtdeProduto > 0 ? item.QtdeProduto : 1)
                                               *(item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo : 1)
                                               *(item.QtdeAviamento > 0 ? item.QtdeAviamento : 1)
                                               *item.AviamentoConsumo;
                            }
                            @subTotal.ToString("N2")
                        </td>
                    </tr>
                
                                subTotalConsumoAv += item.AviamentoConsumo;
                                subTotalTotalAv += subTotal;
                
                }
                else
                {
                    <tr><td class="esconder" colspan="6"></td><th>@subTotalStringAv</th><th>@subTotalConsumoAv.ToString("N2")</th><th>@subTotalTotalAv.ToString("N2")</th></tr>
                    subTotalConsumoAv = 0.00;
                    subTotalTotalAv = 0.00;
                    subTotalStringAv = item.AviamentoNome;
                    
                    
                    <tr class="esconder">
                        <td>@item.Pedido</td>
                        <td>
                            @{
                                var qtdeProd = item.QtdeProduto > 0 ? item.QtdeProduto.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeProd
                        </td>
                        <td>@item.ProdutoNome</td>
                        <td>
                            @{
                                var qtdePASubtotal = item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdePASubtotal
                        </td>
                        <td>@item.ParteAcrescimoNome</td>
                        <td>
                            @{
                                var qtdeA = item.QtdeAviamento > 0 ? item.QtdeAviamento.ToString(CultureInfo.InvariantCulture) : string.Empty;
                            }
                            @qtdeA
                        </td>
                        <td>@item.AviamentoNome</td>
                        <td>@item.AviamentoConsumo.ToString("N2")</td>
                        <td>
                            @{
                                var subTotal = (item.QtdeProduto > 0 ? item.QtdeProduto : 1)
                                               *(item.QtdeParteAcrescimo > 0 ? item.QtdeParteAcrescimo : 1)
                                               *(item.QtdeAviamento > 0 ? item.QtdeAviamento : 1)
                                               *item.AviamentoConsumo;
                            }
                            @subTotal.ToString("N2")
                        </td>
                    </tr>     
                
                    subTotalConsumoAv += item.AviamentoConsumo;
                                subTotalTotalAv += subTotal;
                              
                }
            }
            <tr><td class="esconder" colspan="6"></td><th>@subTotalStringAv</th><th>@subTotalConsumoAv.ToString("N2")</th><th>@subTotalTotalAv.ToString("N2")</th></tr>
        </table>
        }
    </div>
}

<script src="~/Scripts/ajax/relatorio.js"></script>